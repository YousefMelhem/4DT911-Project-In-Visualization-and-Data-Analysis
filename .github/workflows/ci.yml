name: Pull Request Tests

on:
  pull_request:
    branches: [master, main]

jobs:
  test-frontend:
    name: Test Vue.js Frontend
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./medpix-explorer
    
    strategy:
      matrix:
        node-version: [20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: './medpix-explorer/package-lock.json'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run linting
        run: npm run lint
      
      - name: Check TypeScript types
        run: npm run type-check
      
      - name: Run unit tests
        run: npm run test:unit
      
      - name: Build application
        run: npm run build

  security-scan:
    name: Basic Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run npm audit (frontend)
        run: |
          cd medpix-explorer
          npm audit --audit-level=high
        continue-on-error: true
      
      - name: Check for common security issues
        run: |
          echo "üîç Checking for common security issues..."
          # Check for hardcoded secrets patterns
          if grep -r "password\|secret\|key\|token" --include="*.js" --include="*.ts" --include="*.vue" medpix-explorer/src/ | grep -v "test" | grep -v "spec"; then
            echo "‚ö†Ô∏è  Potential hardcoded secrets found"
            exit 1
          else
            echo "‚úÖ No obvious hardcoded secrets found"
          fi

  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    needs: [test-frontend, security-scan]
    
    steps:
      - name: Quality Gate Passed
        run: echo "All quality checks passed! üéâ"
      
      - name: PR Ready for Review
        run: |
          echo "‚úÖ Frontend tests passed"
          echo "‚úÖ Security scan completed"
          echo "‚úÖ Pull Request is ready for review!"
